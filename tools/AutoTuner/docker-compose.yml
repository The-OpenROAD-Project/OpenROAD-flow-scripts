version: "3.8"

services:
  # Ray Head Node (Server)
  ray-head:
    image: openroad/flow-ubuntu22.04-builder:365eae
    container_name: ray-head
    command: |
      sh -c "cd /OpenROAD-flow-scripts && pip install ./tools/AutoTuner/requirements.txt && ray start --head --dashboard-port=8265 --port=6379 --dashboard-host=0.0.0.0 --block"
    volumes:
      - ../../flow:/OpenROAD-flow-scripts/flow
      - ../../tools/AutoTuner:/OpenROAD-flow-scripts/tools/AutoTuner
    ports:
      - "6379:6379" # redis
      - "8265:8265" # dashboard
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8265 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 10s

  # Ray Worker Node
  ray-worker:
    image: openroad/flow-ubuntu22.04-builder:365eae
    container_name: ray-worker
    command: |
      sh -c "cd /OpenROAD-flow-scripts && pip install -r ./tools/AutoTuner/requirements.txt && ray start --address=ray-head:6379 --block"
    volumes:
      - ../../flow:/OpenROAD-flow-scripts/flow
      - ../../tools/AutoTuner:/OpenROAD-flow-scripts/tools/AutoTuner
    healthcheck:
      test: ["CMD-SHELL", "pgrep -f 'ray::' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 10s
